<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="UTF-8">
            
            <title>雙北所得地圖 帶你看貧富差距</title>
            <style>
                #map{ width: 100%; height: 100vh;}
                div.legend {
                    position: absolute;
                    text-align: left;
                    width: 310px;
                    height: 60px;
                    left: 5%;
                    top: 80px;
                    padding: 2px;
                    font: 12px sans-serif;
                    background: rgba(255,255,255,0.5);
                    border: 0px;
                    border-radius: 4px;
                    pointer-events: none;
                }
            div.title {
                position: absolute;
                text-align: left;
                color: #159957;
                font-size: 1.5rem;
                left: 5%;
                top: 10px;
                padding: 10px;
                border: 0px;
                border-radius: 4px;
                background: rgba(255,255,255,0.5);
            }
            .subdist {
                stroke: white;
                stroke-width: 0.5;
            }
            div.tooltip {
                position: absolute;
                text-align: center;
                width: 80px;
                height: 28px;
                padding: 2px;
                font: 12px sans-serif;
                background: white;
                border: 0px;
                border-radius: 8px;
                pointer-events: none;
            }
            </style>
            <meta name="viewport" content="width=device-width, initial-scale=1"/>
            <meta property="og:image" content="https://raw.githubusercontent.com/missmoss/taipei-stat-mrt/gh-pages/front.png"/>
            <meta property="og:description" content="台北的有錢人都住在大安區嗎？過個馬路，居民收入就差20萬？雙北所得地圖與賦稅資料圖表告訴你區域貧富差距。"/>
            <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen"/>
            <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' 'type='text/css'/>
            <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen"/>
            <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen"/>
            <link rel="stylesheet" href="https://npmcdn.com/leaflet@0.7.7/dist/leaflet.css" />
            <link rel="stylesheet" type="text/css" href="stylesheets/jquery.fullPage.css" />
            <script src="https://npmcdn.com/leaflet@0.7.7/dist/leaflet.js"></script>
            <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
            <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
            <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
            <script src="https://d3js.org/d3.v3.min.js"></script>
            <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
            <script type="text/javascript" src="stylesheets/jquery.fullPage.js"></script>
            <!--
             <script>
             (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
             (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
             m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
             })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
             
             ga('create', 'UA-79159343-1', 'auto');
             ga('send', 'pageview');
             
             </script>
             -->
            <script>
                $(document).ready(function() {
                    $('#fullpage').fullpage();
                });
            </script>
            </head>
    
    <body>
        <div id="fullpage">
            <div class="section">
                <section class="main-content">
                    <img src="front.png" style="max-width:50%;float:left;margin-right:1.5%;"/>
                    <h1>雙北所得地圖<br>帶你看貧富差距</h1>
                    <p>製作／<a href="https://github.com/missmoss">@missmoss</a></p>
                    <p>台北的有錢人都住在大安區嗎？過個馬路，居民收入就差20萬？雙北所得地圖與所得稅資料圖表告訴你區域貧富差距。</p>
                </section>
            </div>
            <div class="section">
                <div id="map"></div>
            </div>
            <!--
             <div class="section">
             <section class="main-content">
             <h1>我是h1</h1>
             <h2>我是h2</h2>
             <h3>我是h3</h3>
             <h4>我是h4</h4>
             <h5>我是h5</h5>
             <p>我是p</p>
             <pre><code>我是code</code></pre>
             </section>
             </div>
             -->
            <div class="section">
                <section class="main-content">
                    <h3>雙北所得地圖</h3>
                    <p>將台北市、新北市101年所得稅統計資料各村里所得稅中位數畫成熱圖，顏色越粉紅，所得稅中位數越高，顏色越綠，該村里所得稅中位數越低，並疊上捷運線圖。</p>
                    <p>另所得稅統計資料處理過程繁複，需時較久，目前資料僅釋出至101年度，故以101年度作圖。</p>
                    
                </section>
            </div>
            <div class="section">
                <section class="main-content">
                    <h3>資料來源</h3>
                    101年所得稅統計資料：<a href="http://data.gov.tw/">政府資料開放平台</a> <a href="http://data.gov.tw/node/17983">台北市</a>、<a href="http://data.gov.tw/node/17975">新北市</a></br>
                    捷運站點位置： <a href="https://github.com/repeat" class="user-mention">@repeat</a>/<a href="https://github.com/repeat/taipei-metro-stations">taipei-metro-stations</a>
                    <h3>延伸自</h3>
                    <a href="http://missmoss.github.io/taipei-mrt-viz/">台北捷運一日進出站流量</a></br>
                    <footer class="site-footer">
                        <span class="site-footer-owner"><a href="https://github.com/missmoss/taipei-stat-mrt">台北都會區各項統計與台北捷運</a> 由 <a href="https://github.com/missmoss"> @missmoss</a> 製作。</span>
                        <!--<span class="site-footer-credits">The front photo is via courtesy of <a href="https://www.flickr.com/photos/lipon/11730442194/">liponan</a>.</span>-->
                        <span class="site-footer-credits">本頁面是 <a href="https://pages.github.com">GitHub Pages</a> ，修改自由 <a href="https://twitter.com/jasonlong">Jason Long</a> 製作的 <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a>。特別感謝林怡、務熙學長、鴨鴨、有有、南哥、Kn 在製作過程的討論與協助。</span>
                    </footer>
                    
                </section>
            </div>
        </div>
        
        <script>
            /* Set up Leaflet.js map */
            var northEast = L.latLng(25.3,121.8),
            southWest = L.latLng(24.7,121.258),
            bounds = L.latLngBounds(southWest, northEast);
            
            var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
                subdomain: 'abcd'
                });
        
        var map = L.map('map', {
            scrollWheelZoom: false,
            doubleClickZoom: false,
            center: [25.045,121.547],
            zoom: 13,
            zoomControl: false,
            maxBounds: bounds
            });
        
        map.addLayer(layer);
        
        /* Initialize the SVG layer */
        map._initPathRoot()
        
        /* Set up svg and some elements for charts */
        
        /* svg1 for Heatmap */
        /* We simply pick up the SVG from the map object */
        
        var svg1 = d3.select("#map").select("svg");
        g = svg1.append("g");
        
        var div = d3.select("#map").append("div")
        .attr("class", "legend");
        
        var tooltip = d3.select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);
        
        var svg2 = d3.select(map.getPanes().overlayPane).append("svg"),
        g2 = svg2.append("g").attr("class", "dist");
        
        var titlediv = d3.select("#map").append("div")
        .attr("class", "title");
        
        titlediv.text("雙北所得地圖");
        
        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        d3.json("twnsub2.json", function(collection) {
            
            var incomeMedian = collection.features.map(function(item) {
                return parseInt(item.properties.INCOME_MEDIAN);
            }
            )
            
            var extent = d3.extent(incomeMedian),
            middle = (extent[0]+extent[1])/2;
            console.log(extent[0], middle, extent[1]);
            
            var fillColor = d3.scale.linear()
            .domain([extent[0], middle, extent[1]])
            .range(["#52FFB0", "#5468E8", "#E84374"]);
            
            //legend
            var legend = [300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200];
            
            var rectWidth = 27;
            
            div = div.append("svg");
            
            div.append("text")
            .attr("x", 5)
            .attr("y", 18)
            .attr("fill", "#6C6C6C")
            .style("font-size", 14)
            .text("雙北各里年度家戶所得中位數");
            
            div.selectAll(".legend")
            .data(legend)
            .enter()
            .append("rect")
            .attr("x", function(d,i) { return 10+rectWidth*i; })
            .attr("y", 25)
            .attr("width", rectWidth)
            .attr("height", 10)
            .attr("fill", function(d) { return fillColor(d); })
            .style("opacity", 0.4);
            
            div.selectAll(".legendtext")
            .data(legend)
            .enter()
            .append("text")
            .attr("text-anchor", "start")
            .attr("x", function(d,i) { return 5+rectWidth*i; })
            .attr("y", 50)
            .attr("fill", "#6C6C6C")
            .text(function(d) { return d/10;});
            
            div.append("text")
            .attr("text-anchor", "start")
            .attr("x", rectWidth*10+5)
            .attr("y", 49)
            .attr("fill", "#6C6C6C")
            .text("萬元");
            
            
            var transform = d3.geo.transform({point: projectPoint}),
            path = d3.geo.path().projection(transform);
            
            var feature = g2.selectAll(".subdist")
            .data(collection.features)
            .enter().append("path")
            .attr("class", "subdist")
            .attr("fill", function(d) {
                
                // Get data value
                var value = d.properties.INCOME_MEDIAN;
                
                if (value) {
                    //If value exists…
                    return fillColor(value);
                } else {
                    //If value is undefined…
                    return "white";
                }
            })
            .on("mouseover", function(d) {
                d3.select(this)
                .style("opacity", 0.75);
                tooltip.transition()
                .duration(200)
                .style("opacity", .9);
                tooltip.text(function () {
                    return d.properties.TOWN+'\n'+
                    d.properties.VILLAGE+'\n'+
                    numberWithCommas(d.properties.INCOME_MEDIAN)+',000 元';
                })
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 28) + "px");
            })
            .on("mouseout", function(d) {
                d3.select(this)
                .style("opacity", 0.3);
                tooltip.transition()
                .duration(500)
                .style("opacity", 0);
            })
            .style("opacity", 0.3);
            
            //d3 code stolen from http://bost.ocks.org/mike/leaflet/#init
            
            map.on("viewreset", reset);
            reset();
            
            function reset() {
                var topobounds = path.bounds(collection),
                topLeft = topobounds[0],
                bottomRight = topobounds[1];
                
                svg2.attr("width", bottomRight[0] - topLeft[0])
                .attr("height", bottomRight[1] - topLeft[1])
                .style("left", topLeft[0] + "px")
                .style("top", topLeft[1] + "px");
                g2.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
                
                feature.attr("d", path);
            }
            
            function projectPoint(x, y) {
                var point = map.latLngToLayerPoint(new L.LatLng(y, x));
                this.stream.point(point.x, point.y);
            }
            
            
        });
        
        //twnsublatlng.json Village_NLSC_121_1050219 25.0853403,121.4231634
        
        
        d3.csv("taipei.csv", function(data) {
            
            var transform = d3.geo.transform({point: projectPoint}),
            d3path = d3.geo.path().projection(transform);
            
            function projectPoint(x, y) {
                var point = map.latLngToLayerPoint(new L.LatLng(x, y));
                this.stream.point(point.x, point.y);
            }
            
            var lines = {"1":{
                color: "brown",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "2": {
                color: "red",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "3": {
                color: "green",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "4": {
                color: "orange",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "4-1": {
                color: "orange",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "5": {
                color: "blue",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "n": {
                color: "red",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }},
            "s": {
                color: "green",
                geoLineString: {
                    type: "LineString",
                    coordinates: []
                }}
            };
            
            data.forEach(function(d) {
                lines[d.line_no].geoLineString.coordinates.push(
                [parseFloat(d.lat), parseFloat(d.lon)]);
            });
            
            var keys = d3.keys(lines).filter(function(key, d) {
                return key;
            });
            
            var lines2 = [];
            
            keys.forEach(function(key) {
                var tmpdata = lines[key];
                tmpdata['line_no'] = key;
                lines2.push(tmpdata);
            });
            
            var linePath = g.selectAll(".lineConnect")
            .data(lines2)
            .enter()
            .append("path")
            .attr("class", "lineConnect")
            .attr("id", function(d) {return d.line_no; })
            .attr("stroke", function(d) { return d.color; })
            .attr("fill", "None")
            .style("opacity", 1)
            .attr("d", function(d) { return d3path(d.geoLineString); });
            
            map.on("viewreset", updateMap);
            updateMap();
            
            function updateMap() {
                linePath.attr("transform",
                    function(d) {
                        d.x = map.latLngToLayerPoint(d.LatLng).x;
                        d.y = map.latLngToLayerPoint(d.LatLng).y;
                        return "translate("+d.x +","+d.y +")";
                    }
                )};
            
            
        }); //end of d3.csv("taipei.csv")
        </script>
    </body>
</html>
